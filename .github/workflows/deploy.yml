name: BeOrchid ML CI/CD

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Build and push Docker image
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --tag ${{ secrets.DOCKER_USERNAME }}/beorchid-ml:latest \
            --push \
            .

      # Deploy on provisioned EC2
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_IP }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/beorchid-ml || mkdir ~/beorchid-ml && cd ~/beorchid-ml

            # Update system
            sudo yum update -y

            # Install Docker
            sudo yum install -y docker

            # Start & enable Docker service
            sudo systemctl start docker
            sudo systemctl enable docker

            # Add ec2-user to docker group
            sudo usermod -aG docker ec2-user

            # Install Docker Compose v2 plugin
            sudo mkdir -p /usr/local/lib/docker/cli-plugins
            sudo curl -SL https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 -o /usr/local/lib/docker/cli-plugins/docker-compose
            sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

            # Verify installation
            docker --version
            docker compose version

            # Cleanup old containers/images
            docker stop $(docker ps -a -q) 2>/dev/null || true
            docker rm $(docker ps -a -q) 2>/dev/null || true
            docker rmi $(docker images -a -q) 2>/dev/null || true

            # Write .env
            echo "${{ secrets.ENV_FILE }}" > .env

            # Download docker-compose.yml from repository
            curl -L -o docker-compose.yml \
              https://raw.githubusercontent.com/fkaaziebu/beorchid-ml/main/docker-compose.yml

            # Verify the file
            echo "docker-compose.yml:"
            cat docker-compose.yml

            # Download and extract ML models (skip if already present)
            if [ ! -d "./models/weights" ]; then
              echo "Downloading ML models from Google Drive..."
              sudo yum install -y unzip
              FILE_ID="1vMhgT6vrKcspSxHOjT-FXJ3kDch3UO7D"
              curl -L -o models.zip \
                "https://drive.usercontent.google.com/download?id=${FILE_ID}&export=download&authuser=0&confirm=t&uuid=e459dcac-7aa3-473a-93cc-145d29e548cf&at=APcXIO2T81eq7H0IFPETAqooyu5l:1771009474676"
              mkdir -p ./models_tmp
              unzip -o models.zip -d ./models_tmp

              # Reorganize into the flat structure the app expects
              mkdir -p ./models/weights ./models/json

              # YOLO detector
              # cp "./models_tmp/models/models/weights/yolo/yolov8n.pt" \
              #    "./models/weights/yolov8n.pt"

              # Cashew mobilenetv2 classifier (weights + metadata)
              cp "./models_tmp/models/models/weights/cashew/cachew_enhanced_mobilenetv2.weights (2).h5" \
                 "./models/weights/enhanced_mobilenetv2.weights.h5"
              cp "./models_tmp/models/models/json/cashew/cashew_enhanced_mobilenetv2_metadata (1).json" \
                 "./models/json/enhanced_mobilenetv2_metadata.json"

              # Cleanup temp
              rm -rf ./models_tmp models.zip
              echo "Models organized into ./models:"
              ls -R ./models
            else
              echo "Models already present, skipping download."
            fi

            # Pull latest image and start app
            docker pull fkaaziebu/beorchid-ml:latest
            docker compose up -d --remove-orphans
